import tkinter as tk
from tkinter import Canvas, messagebox, ttk
import threading
import time
from datetime import datetime

import pyaudio
from tts import speak
from stt import listen
from improved_llm_handler import create_voice_assistant
import os

class VoiceAssistantGUI:
    def __init__(self):
        # Kh·ªüi t·∫°o LLM Assistant v·ªõi memory
        self.assistant = create_voice_assistant()
        self.session_id = self.assistant.start_new_session("main_user")
        
        # Tr·∫°ng th√°i
        self.is_listening = False
        self.chat_messages = []
        self.current_session_name = f"Phi√™n {datetime.now().strftime('%d/%m %H:%M')}"
        
        # Kh·ªüi t·∫°o GUI
        self.setup_gui()
        
    def setup_gui(self):
        """Thi·∫øt l·∫≠p giao di·ªán ng∆∞·ªùi d√πng"""
        self.root = tk.Tk()
        self.root.title("üé§ Tr·ª£ l√Ω ·∫£o th√¥ng minh - Voice Assistant")
        self.root.geometry("900x700")
        self.root.resizable(True, True)
        self.root.configure(bg="#f0f2f5")
        
        # Main container
        self.setup_main_layout()
        
        # Left panel - Chat area
        self.setup_left_panel()
        
        # Right panel - History
        self.setup_right_panel()
        
        # Welcome message
        self.add_message("AI", "Xin ch√†o! T√¥i l√† tr·ª£ l√Ω ·∫£o c·ªßa b·∫°n. H√£y nh·∫•n n√∫t mic ƒë·ªÉ n√≥i nh√©! üé§‚ú®")
        
    def setup_main_layout(self):
        """Thi·∫øt l·∫≠p layout ch√≠nh"""
        # Main frame
        self.main_frame = tk.Frame(self.root, bg="#f0f2f5")
        self.main_frame.pack(fill="both", expand=True, padx=10, pady=10)
        
        # Left frame (Chat)
        self.left_frame = tk.Frame(self.main_frame, bg="white", relief="raised", bd=1)
        self.left_frame.pack(side="left", fill="both", expand=True, padx=(0, 5))
        
        # Right frame (History)
        self.right_frame = tk.Frame(self.main_frame, bg="white", relief="raised", bd=1, width=280)
        self.right_frame.pack(side="right", fill="y", padx=(5, 0))
        self.right_frame.pack_propagate(False)
    
    def setup_left_panel(self):
        """Thi·∫øt l·∫≠p panel tr√°i - khu v·ª±c chat"""
        # Header
        header_frame = tk.Frame(self.left_frame, bg="#2196F3", height=60)
        header_frame.pack(fill="x")
        header_frame.pack_propagate(False)
        
        title_label = tk.Label(
            header_frame,
            text="üí¨ Tr√≤ chuy·ªán v·ªõi AI",
            font=("Segoe UI", 16, "bold"),
            fg="white",
            bg="#2196F3"
        )
        title_label.pack(pady=15)
        
        # Chat area
        chat_container = tk.Frame(self.left_frame, bg="white")
        chat_container.pack(fill="both", expand=True, padx=10, pady=10)
        
        # Scrollable chat zone
        self.chat_canvas = tk.Canvas(chat_container, bg="#fafafa", highlightthickness=0)
        self.scrollbar = ttk.Scrollbar(chat_container, orient="vertical", command=self.chat_canvas.yview)
        self.chat_frame = tk.Frame(self.chat_canvas, bg="#fafafa")
        
        self.chat_frame.bind(
            "<Configure>",
            lambda e: self.chat_canvas.configure(scrollregion=self.chat_canvas.bbox("all"))
        )
        
        self.chat_canvas.create_window((0, 0), window=self.chat_frame, anchor="nw")
        self.chat_canvas.configure(yscrollcommand=self.scrollbar.set)
        
        self.chat_canvas.pack(side="left", fill="both", expand=True)
        self.scrollbar.pack(side="right", fill="y")
        
        # Control area
        control_frame = tk.Frame(self.left_frame, bg="white", height=120)
        control_frame.pack(fill="x", padx=10, pady=10)
        control_frame.pack_propagate(False)
        
        # Status bar
        self.status_label = tk.Label(
            control_frame,
            text="üéôÔ∏è Nh·∫•n n√∫t ƒë·ªÉ n√≥i...",
            font=("Segoe UI", 12),
            fg="#666",
            bg="white"
        )
        self.status_label.pack(pady=(0, 10))
        
        # Voice button
        self.setup_voice_button(control_frame)
    
    def setup_right_panel(self):
        """Thi·∫øt l·∫≠p panel ph·∫£i - l·ªãch s·ª≠ cu·ªôc tr√≤ chuy·ªán"""
        # Header
        history_header = tk.Frame(self.right_frame, bg="#4CAF50", height=60)
        history_header.pack(fill="x")
        history_header.pack_propagate(False)
        
        history_title = tk.Label(
            history_header,
            text="üìö L·ªãch s·ª≠ tr√≤ chuy·ªán",
            font=("Segoe UI", 14, "bold"),
            fg="white",
            bg="#4CAF50"
        )
        history_title.pack(pady=15)
        
        # Current session info
        session_info_frame = tk.Frame(self.right_frame, bg="#e8f5e8", height=50)
        session_info_frame.pack(fill="x", padx=5, pady=5)
        session_info_frame.pack_propagate(False)
        
        current_session_label = tk.Label(
            session_info_frame,
            text="üìù Phi√™n hi·ªán t·∫°i:",
            font=("Segoe UI", 10, "bold"),
            fg="#2e7d32",
            bg="#e8f5e8"
        )
        current_session_label.pack(anchor="w", padx=10, pady=2)
        
        self.current_session_label = tk.Label(
            session_info_frame,
            text=self.current_session_name,
            font=("Segoe UI", 9),
            fg="#4caf50",
            bg="#e8f5e8"
        )
        self.current_session_label.pack(anchor="w", padx=20)
        
        # Buttons frame
        buttons_frame = tk.Frame(self.right_frame, bg="white")
        buttons_frame.pack(fill="x", padx=10, pady=5)
        
        # New session button
        self.new_session_btn = tk.Button(
            buttons_frame,
            text="üÜï Phi√™n m·ªõi",
            font=("Segoe UI", 10, "bold"),
            bg="#FF9800",
            fg="white",
            relief="flat",
            padx=20,
            pady=5,
            command=self.start_new_session
        )
        self.new_session_btn.pack(fill="x", pady=2)
        
        # Clear history button
        self.clear_btn = tk.Button(
            buttons_frame,
            text="üóëÔ∏è X√≥a l·ªãch s·ª≠",
            font=("Segoe UI", 10),
            bg="#f44336",
            fg="white",
            relief="flat",
            padx=20,
            pady=5,
            command=self.clear_history
        )
        self.clear_btn.pack(fill="x", pady=2)
        
        # Sessions list
        sessions_label = tk.Label(
            self.right_frame,
            text="üìã C√°c phi√™n tr∆∞·ªõc:",
            font=("Segoe UI", 11, "bold"),
            fg="#333",
            bg="white"
        )
        sessions_label.pack(anchor="w", padx=10, pady=(10, 5))
        
        # Sessions listbox with scrollbar
        listbox_frame = tk.Frame(self.right_frame, bg="white")
        listbox_frame.pack(fill="both", expand=True, padx=10, pady=5)
        
        self.sessions_listbox = tk.Listbox(
            listbox_frame,
            font=("Segoe UI", 9),
            bg="#f9f9f9",
            fg="#333",
            selectbackground="#2196F3",
            selectforeground="white",
            relief="flat",
            bd=1
        )
        
        listbox_scrollbar = ttk.Scrollbar(listbox_frame, orient="vertical", command=self.sessions_listbox.yview)
        self.sessions_listbox.configure(yscrollcommand=listbox_scrollbar.set)
        
        self.sessions_listbox.pack(side="left", fill="both", expand=True)
        listbox_scrollbar.pack(side="right", fill="y")
        
        # Bind double-click to view session
        self.sessions_listbox.bind("<Double-Button-1>", self.view_selected_session)
        
        # Load existing sessions
        self.refresh_sessions_list()
        
        # Stats frame
        stats_frame = tk.Frame(self.right_frame, bg="#f0f0f0", height=60)
        stats_frame.pack(fill="x", padx=5, pady=5)
        stats_frame.pack_propagate(False)
        
        self.stats_label = tk.Label(
            stats_frame,
            text="üìä Tin nh·∫Øn trong phi√™n: 0",
            font=("Segoe UI", 9),
            fg="#666",
            bg="#f0f0f0"
        )
        self.stats_label.pack(pady=15)
    
    def setup_voice_button(self, parent):
        """Thi·∫øt l·∫≠p n√∫t voice"""
        button_frame = tk.Frame(parent, bg="white")
        button_frame.pack()
        
        self.button_canvas = Canvas(button_frame, width=80, height=80, bg="white", highlightthickness=0)
        self.button_canvas.pack()
        
        self.create_round_button(self.button_canvas, 40, 40, 30, command=self.start_listening)
    
    def create_round_button(self, canvas, x, y, r, command=None):
        """T·∫°o n√∫t tr√≤n v·ªõi hi·ªáu ·ª©ng ƒë·∫πp"""
        # Gradient shadow
        for i in range(3):
            shadow_alpha = 0.1 + (i * 0.05)
            shadow_color = f"#{int(33 * shadow_alpha):02x}{int(150 * shadow_alpha):02x}{int(243 * shadow_alpha):02x}"
            canvas.create_oval(
                x - r + i + 2, y - r + i + 2, 
                x + r + i + 2, y + r + i + 2, 
                fill=shadow_color, outline=""
            )
        
        # Main button with gradient effect
        self.button_item = canvas.create_oval(x - r, y - r, x + r, y + r, fill="#2196F3", outline="", width=0)
        
        # Inner glow
        inner_glow = canvas.create_oval(x - r + 3, y - r + 3, x + r - 3, y + r - 3, fill="#42A5F5", outline="")
        
        # Icon mic
        self.mic_icon = canvas.create_text(x, y, text="üé§", font=("Segoe UI", 18, "bold"), fill="white")
        
        def on_click(event):
            if command:
                # Animation effect
                canvas.itemconfig(self.button_item, fill="#1976D2")
                canvas.after(100, lambda: canvas.itemconfig(self.button_item, fill="#2196F3"))
                command()
        
        # Hover effects
        def on_enter(event):
            canvas.itemconfig(self.button_item, fill="#1E88E5")
        
        def on_leave(event):
            if not self.is_listening:
                canvas.itemconfig(self.button_item, fill="#2196F3")
        
        # Bind events
        for item in [self.button_item, inner_glow, self.mic_icon]:
            canvas.tag_bind(item, "<Button-1>", on_click)
            canvas.tag_bind(item, "<Enter>", on_enter)
            canvas.tag_bind(item, "<Leave>", on_leave)
    
    def update_status(self, message):
        """C·∫≠p nh·∫≠t tr·∫°ng th√°i"""
        self.status_label.config(text=message)
        self.root.update()
    
    def add_message(self, sender, message):
        """Th√™m tin nh·∫Øn v√†o chat v·ªõi style ƒë·∫πp"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        
        # Frame cho message
        msg_frame = tk.Frame(self.chat_frame, bg="#fafafa")
        msg_frame.pack(fill="x", padx=15, pady=8)
        
        # Style cho user v√† AI kh√°c nhau
        if sender == "B·∫°n":
            # Message c·ªßa user - cƒÉn ph·∫£i, m√†u xanh
            bubble_color = "#E3F2FD"
            text_color = "#1565C0"
            border_color = "#2196F3"
            anchor = "e"
            emoji = "üë§"
        else:
            # Message c·ªßa AI - cƒÉn tr√°i, m√†u xanh l√°
            bubble_color = "#E8F5E8"
            text_color = "#2E7D32"
            border_color = "#4CAF50"
            anchor = "w"
            emoji = "ü§ñ"
        
        # Bubble message v·ªõi border ƒë·∫πp
        bubble_frame = tk.Frame(
            msg_frame, 
            bg=bubble_color, 
            relief="solid", 
            bd=1
        )
        bubble_frame.pack(anchor=anchor, padx=(0 if anchor=="w" else 80, 80 if anchor=="w" else 0))
        
        # Header v·ªõi avatar v√† time
        header_frame = tk.Frame(bubble_frame, bg=bubble_color)
        header_frame.pack(fill="x", padx=12, pady=(8, 2))
        
        sender_info = tk.Label(
            header_frame,
            text=f"{emoji} {sender}",
            font=("Segoe UI", 9, "bold"),
            fg=text_color,
            bg=bubble_color
        )
        sender_info.pack(side="left")
        
        time_label = tk.Label(
            header_frame,
            text=timestamp,
            font=("Segoe UI", 8),
            fg="#666",
            bg=bubble_color
        )
        time_label.pack(side="right")
        
        # Message content v·ªõi wrapping
        msg_label = tk.Label(
            bubble_frame,
            text=message,
            font=("Segoe UI", 11),
            fg=text_color,
            bg=bubble_color,
            wraplength=350,
            justify="left"
        )
        msg_label.pack(anchor="w", padx=12, pady=(0, 8))
        
        # Update stats
        self.update_message_stats()
        
        # Auto scroll to bottom
        self.root.update()
        self.chat_canvas.yview_moveto(1)
    
    def start_listening(self):
        """B·∫Øt ƒë·∫ßu l·∫Øng nghe gi·ªçng n√≥i"""
        if self.is_listening:
            return
        
        self.is_listening = True
        # ƒê·ªïi icon th√†nh ƒëang ghi √¢m v·ªõi hi·ªáu ·ª©ng
        self.button_canvas.itemconfig(self.mic_icon, text="üî¥")
        self.button_canvas.itemconfig(self.button_item, fill="#F44336")
        
        # Ch·∫°y trong thread ri√™ng ƒë·ªÉ kh√¥ng block UI
        threading.Thread(target=self.handle_voice_interaction, daemon=True).start()
    
    def handle_voice_interaction(self):
        """X·ª≠ l√Ω t∆∞∆°ng t√°c gi·ªçng n√≥i"""
        try:
            # L·∫Øng nghe
            self.update_status("üéß ƒêang l·∫Øng nghe... H√£y n√≥i ƒëi·ªÅu g√¨ ƒë√≥!")
            
            user_input = listen(self.update_status)
            
            if user_input:
                # Hi·ªÉn th·ªã input c·ªßa user
                self.add_message("B·∫°n", user_input)
                
                # X·ª≠ l√Ω v·ªõi LLM
                self.update_status("ü§ñ ƒêang suy nghƒ©...")
                
                try:
                    ai_response = self.assistant.ask_llm(user_input)
                    
                    # Hi·ªÉn th·ªã response
                    self.add_message("AI", ai_response)
                    
                    # ƒê·ªçc response
                    self.update_status("üîä ƒêang tr·∫£ l·ªùi...")
                    speak(ai_response)
                    
                except Exception as e:
                    error_msg = "Xin l·ªói, t√¥i g·∫∑p s·ª± c·ªë khi x·ª≠ l√Ω c√¢u h·ªèi."
                    self.add_message("AI", error_msg)
                    speak(error_msg)
                    print(f"LLM Error: {e}")
            
            else:
                self.update_status("‚ùå Kh√¥ng nghe ƒë∆∞·ª£c. Th·ª≠ l·∫°i nh√©!")
                
        except Exception as e:
            self.update_status("üîß L·ªói microphone. Ki·ªÉm tra thi·∫øt b·ªã!")
            print(f"Voice Error: {e}")
        
        finally:
            # Reset button state
            self.is_listening = False
            self.button_canvas.itemconfig(self.mic_icon, text="üé§")
            self.button_canvas.itemconfig(self.button_item, fill="#2196F3")
            self.update_status("üéôÔ∏è Nh·∫•n n√∫t ƒë·ªÉ n√≥i...")
    
    def start_new_session(self):
        """B·∫Øt ƒë·∫ßu phi√™n tr√≤ chuy·ªán m·ªõi"""
        # L∆∞u session c≈© v√†o l·ªãch s·ª≠
        if hasattr(self, 'session_id') and self.session_id:
            old_session_name = self.current_session_name
            self.sessions_listbox.insert(0, f"üìù {old_session_name}")
        
        # T·∫°o session m·ªõi
        self.session_id = self.assistant.start_new_session("main_user")
        self.current_session_name = f"Phi√™n {datetime.now().strftime('%d/%m %H:%M')}"
        self.current_session_label.config(text=self.current_session_name)
        
        # Clear chat area
        for widget in self.chat_frame.winfo_children():
            widget.destroy()
        
        # Welcome message
        self.add_message("AI", "‚ú® Phi√™n tr√≤ chuy·ªán m·ªõi b·∫Øt ƒë·∫ßu! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?")
        
        messagebox.showinfo("Th√†nh c√¥ng", "üÜï ƒê√£ t·∫°o phi√™n tr√≤ chuy·ªán m·ªõi!")
    
    def clear_history(self):
        """X√≥a l·ªãch s·ª≠ cu·ªôc tr√≤ chuy·ªán"""
        result = messagebox.askyesno(
            "X√°c nh·∫≠n", 
            "üóëÔ∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!"
        )
        if result:
            self.sessions_listbox.delete(0, tk.END)
            try:
                self.assistant.clear_conversation()
            except:
                pass
            messagebox.showinfo("Ho√†n t·∫•t", "‚úÖ ƒê√£ x√≥a l·ªãch s·ª≠ tr√≤ chuy·ªán!")
    
    def view_selected_session(self, event):
        """Xem phi√™n ƒë∆∞·ª£c ch·ªçn"""
        selection = self.sessions_listbox.curselection()
        if selection:
            session_name = self.sessions_listbox.get(selection[0])
            messagebox.showinfo(
                "L·ªãch s·ª≠ phi√™n", 
                f"üìñ ƒêang xem: {session_name}\n\nüí° T√≠nh nƒÉng xem chi ti·∫øt s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong phi√™n b·∫£n ti·∫øp theo!"
            )
    
    def refresh_sessions_list(self):
        """L√†m m·ªõi danh s√°ch phi√™n"""
        try:
            # L·∫•y danh s√°ch sessions t·ª´ database
            sessions = self.assistant.memory.get_all_sessions("main_user")
            
            self.sessions_listbox.delete(0, tk.END)
            for session in sessions[:10]:  # Hi·ªÉn th·ªã 10 phi√™n g·∫ßn nh·∫•t
                created_time = session['created_at'].strftime('%d/%m %H:%M')
                message_count = len(session.get('messages', []))
                display_text = f"üìù Phi√™n {created_time} ({message_count} tin nh·∫Øn)"
                self.sessions_listbox.insert(tk.END, display_text)
                
        except Exception as e:
            print(f"Error loading sessions: {e}")
    
    def update_message_stats(self):
        """C·∫≠p nh·∫≠t th·ªëng k√™ tin nh·∫Øn"""
        try:
            if hasattr(self, 'session_id') and self.session_id:
                history = self.assistant.get_conversation_history(100)
                message_count = len(history)
                self.stats_label.config(text=f"üìä Tin nh·∫Øn trong phi√™n: {message_count}")
        except:
            pass
    
    def on_closing(self):
        """X·ª≠ l√Ω khi ƒë√≥ng app"""
        try:
            self.assistant.close()
        except:
            pass
        self.root.destroy()
    
    def run(self):
        """Ch·∫°y ·ª©ng d·ª•ng"""
        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)
        self.root.mainloop()

def main():
    """H√†m main ch√≠nh"""
    try:
        # Ki·ªÉm tra dependencies
        required_files = ['tts.py', 'stt.py', 'improved_llm_handler.py', 'conversation_memory.py']
        for file in required_files:
            if not os.path.exists(file):
                print(f"‚ùå Thi·∫øu file: {file}")
                return
        
        print("üöÄ Kh·ªüi ƒë·ªông Voice Assistant...")
        
        # T·∫°o v√† ch·∫°y ·ª©ng d·ª•ng
        print("üé® ƒêang kh·ªüi ƒë·ªông GUI...")
        app = VoiceAssistantGUI()
        app.run()
        
    except Exception as e:
        print(f"‚ùå L·ªói kh·ªüi ƒë·ªông: {e}")
        messagebox.showerror("L·ªói", f"Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông ·ª©ng d·ª•ng:\n{e}")

if __name__ == "__main__":
    main()